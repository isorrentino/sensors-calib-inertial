<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of MotorPWMcontroller</title>
  <meta name="keywords" content="MotorPWMcontroller">
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # src --><!-- menu.html @MotorPWMcontroller -->
<h1>MotorPWMcontroller
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong></strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../src/+UT/plotterThreadUpdateFcn.html" class="code" title="function plotterThreadUpdateFcn( h,x,y,colors )">plotterThreadUpdateFcn</a>	UNTITLED Summary of this function goes here</li><li><a href="../../src/@JointMotorCoupling/JointMotorCoupling.html" class="code" title="">JointMotorCoupling</a>	</li><li><a href="../../src/@LowlevTauCtrlCalibrator/start.html" class="code" title="function start( obj )">start</a>	Inits the state machine</li><li><a href="MotorPWMcontroller.html" class="code" title="">MotorPWMcontroller</a>	</li><li><a href="ctrllerThreadStartFcn.html" class="code" title="function [ ok ] = ctrllerThreadStartFcn( obj,PIDCtrller )">ctrllerThreadStartFcn</a>	safeguard, update state</li><li><a href="ctrllerThreadStopFcn.html" class="code" title="function [ ok ] = ctrllerThreadStopFcn( obj )">ctrllerThreadStopFcn</a>	Restore on all coupled motors the control mode used prior the position control emulation.</li><li><a href="ctrllerThreadUpdateFcn.html" class="code" title="function [ ok ] = ctrllerThreadUpdateFcn( obj,ctrllerThreadStop,rateThreadPeriod,PIDCtrller )">ctrllerThreadUpdateFcn</a>	Run the PID controller and set the computed PWM values</li><li><a href="plotterThreadStartFcn.html" class="code" title="function plotterThreadStartFcn( obj )">plotterThreadStartFcn</a>	Creates the figure for plotting Tau vs dq</li><li><a href="plotterThreadStopFcn.html" class="code" title="function plotterThreadStopFcn( obj )">plotterThreadStopFcn</a>	Closes the plot figure</li><li><a href="plotterThreadUpdateFcn.html" class="code" title="function plotterThreadUpdateFcn( obj )">plotterThreadUpdateFcn</a>	Plots current joint torque and velocity</li><li><a href="runPwmEmulPosCtrlMode.html" class="code" title="function [ ok ] = runPwmEmulPosCtrlMode( obj,samplingPeriod,timeout )">runPwmEmulPosCtrlMode</a>	UNTITLED Summary of this function goes here</li><li><a href="runRealtimePlotter.html" class="code" title="function [ ok ] = runRealtimePlotter( obj,threadPeriod,threadTimeout )">runRealtimePlotter</a>	UNTITLED Summary of this function goes here</li><li><a href="setMotorPWM.html" class="code" title="function [ ok ] = setMotorPWM( obj,pwm )">setMotorPWM</a>	Set the desired PWM level (Duty cycle) for the currently controlled motor</li><li><a href="start.html" class="code" title="function [ ok ] = start( obj )">start</a>	Set the controlled motor obj.ctrledMotor in PWM control mode.</li><li><a href="stop.html" class="code" title="function [ ok ] = stop( obj )">stop</a>	Stop the PWM controller.</li><li><a href="switchCtrlledMotor.html" class="code" title="function [ ok ] = switchCtrlledMotor( obj,motorName )">switchCtrlledMotor</a>	Select new motor to control in explicit PWM mode.</li><li><a href="../../src/@RateThread/RateThread.html" class="code" title="">RateThread</a>	</li><li><a href="../../src/@RemoteControlBoardRemapper/RemoteControlBoardRemapper.html" class="code" title="">RemoteControlBoardRemapper</a>	</li><li><a href="../../src/@RemoteControlBoardRemapper/setMotorPWM.html" class="code" title="function [ ok ] = setMotorPWM( obj,motorName,pwm )">setMotorPWM</a>	Set the desired PWM value (0-100%) for the named motor</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../src/@MotionSequencer/run.html" class="code" title="function acqSensorDataAccessor = run(obj)">run</a>	</li><li><a href="MotorPWMcontroller.html" class="code" title="">MotorPWMcontroller</a>	</li><li><a href="../../src/app/unitTests.html" class="code" title="">unitTests</a>	Add main folders in Matlab path</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function obj = MotorPWMcontroller(motorName,remCtrlBoardRemapper,threadActivation)</a></li><li><a href="#_sub2" class="code">function delete(obj)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 classdef <a href="MotorPWMcontroller.html" class="code" title="">MotorPWMcontroller</a> &lt; handle
0002     <span class="comment">%Controller for emulating position or velocity control through PWM settings.</span>
0003     <span class="comment">%   The function and execution rate is defined through the class constructor.</span>
0004     
0005     properties (Access=protected)
0006     <span class="keyword">end</span>
0007     
0008     properties (GetAccess=public, SetAccess=protected)
0009         <span class="comment">% control board remapper</span>
0010         remCtrlBoardRemap@<a href="../../src/@RemoteControlBoardRemapper/RemoteControlBoardRemapper.html" class="code" title="">RemoteControlBoardRemapper</a>;
0011         <span class="comment">% controlled motor and respective coupling info</span>
0012         pwmCtrledMotor@struct;
0013         posCtrledMotors@struct;
0014         coupling@<a href="../../src/@JointMotorCoupling/JointMotorCoupling.html" class="code" title="">JointMotorCoupling</a>;
0015         couplingMotorIdxes@double;
0016         couplingJointIdxes@double;
0017         normOfgearboxDqM2Jratios@double;
0018         pwmCtrledMotorBitmapInCoupling@logical;
0019         <span class="comment">% Last state before switching to PWM control emulating Pos control</span>
0020         couplingPrevMode@char;
0021         lastMotorsPosInPrevMode@double;
0022         lastMotorsPwmInPrevMode@double;
0023         <span class="comment">% PID gains and real time synchronization</span>
0024         ctrllerThread@<a href="../../src/@RateThread/RateThread.html" class="code" title="">RateThread</a>;
0025         ctrllerThreadPeriod@double;
0026         pidGains@struct;
0027         <span class="comment">% Position Emulator mode running (for avoiding state</span>
0028         <span class="comment">% inconsistencies)</span>
0029         running@logical;
0030         <span class="comment">% Controller ready for setting PWM (couplings checked and position</span>
0031         <span class="comment">% control emulator activated if necessary)</span>
0032         controllerReady@logical;
0033         <span class="comment">% Previous time of motor encoders measurement</span>
0034         prevMotorsTime@double;
0035         <span class="comment">% test mode</span>
0036         testMode@logical;
0037         <span class="comment">% plotter thread (slave)</span>
0038         plotterThread@<a href="../../src/@RateThread/RateThread.html" class="code" title="">RateThread</a>;
0039         <span class="comment">% temporary plot parameters</span>
0040         tempPlot@struct;
0041     <span class="keyword">end</span>
0042     
0043     methods
0044         <span class="comment">% Constructor</span>
0045         <a name="_sub0" href="#_subfunctions" class="code">function obj = MotorPWMcontroller(motorName,remCtrlBoardRemapper,threadActivation)</a>
0046             <span class="comment">% default init values. Controller not running...</span>
0047             obj.running = false;
0048             obj.ctrllerThreadPeriod = nan;
0049             obj.controllerReady = false;
0050             obj.tempPlot = struct(<span class="string">'figH'</span>,[],<span class="string">'an'</span>,[],<span class="string">'units'</span>,[],<span class="string">'convertFromRad'</span>,[]);
0051             
0052             <span class="comment">% Set control board remapper</span>
0053             obj.remCtrlBoardRemap = remCtrlBoardRemapper;
0054             
0055             <span class="comment">% Get coupled motors/joints</span>
0056             couplings = remCtrlBoardRemapper.robotModel.jointsDbase.getJMcouplings(<span class="string">'motors'</span>,{motorName});
0057             obj.coupling = couplings{1};
0058             <span class="comment">% norm of gearbox ratios</span>
0059             obj.normOfgearboxDqM2Jratios = abs(cell2mat(obj.coupling.gearboxDqM2Jratios));
0060             
0061             <span class="comment">% Get indices of joints and coupled motors</span>
0062             [obj.couplingMotorIdxes,~] = <span class="keyword">...</span>
0063                 obj.remCtrlBoardRemap.getMotorsMappedIdxes(obj.coupling.coupledMotors);
0064             [obj.couplingJointIdxes,~] = <span class="keyword">...</span>
0065                 obj.remCtrlBoardRemap.getJointsMappedIdxes(obj.coupling.coupledJoints);
0066             obj.pwmCtrledMotorBitmapInCoupling = ismember(obj.coupling.coupledMotors,motorName);
0067             
0068             <span class="comment">% set position (emulated) and PWM controlled motor settings</span>
0069             obj.pwmCtrledMotor = struct(<span class="keyword">...</span>
0070                 <span class="string">'name'</span>,motorName,<span class="keyword">...</span>
0071                 <span class="string">'idx'</span>,remCtrlBoardRemapper.getMotorsMappedIdxes({motorName}),<span class="keyword">...</span>
0072                 <span class="string">'pwm'</span>,0);
0073             
0074             posCtrledMotorsIdxes = setdiff(obj.couplingMotorIdxes,obj.pwmCtrledMotor.idx,<span class="string">'stable'</span>);
0075             
0076             obj.posCtrledMotors = struct(<span class="keyword">...</span>
0077                 <span class="string">'idx'</span>,posCtrledMotorsIdxes,<span class="keyword">...</span>
0078                 <span class="string">'pwm'</span>,zeros(size(posCtrledMotorsIdxes)));
0079             
0080             <span class="comment">% Previous time of motor encoders measurement</span>
0081             obj.prevMotorsTime = nan;
0082             
0083             <span class="comment">% start the controller. Check for test mode</span>
0084             <span class="keyword">switch</span> threadActivation
0085                 <span class="keyword">case</span> System.Const.ThreadON
0086                     obj.testMode = false; obj.start();
0087                 <span class="keyword">case</span> System.Const.ThreadTEST
0088                     obj.testMode = true; obj.start();
0089                 <span class="keyword">otherwise</span>
0090             <span class="keyword">end</span>
0091         <span class="keyword">end</span>
0092         
0093         <span class="comment">% Destructor</span>
0094         <a name="_sub1" href="#_subfunctions" class="code">function delete(obj)</a>
0095         <span class="keyword">end</span>
0096         
0097         <span class="comment">% Set the motor in PWM control mode and handle the coupled</span>
0098         <span class="comment">% motors keeping their control mode and state unchanged. If</span>
0099         <span class="comment">% this is not supported by the YARP remoteControlBoardRemapper,</span>
0100         <span class="comment">% emulate it. We can only emulate position control.</span>
0101         ok = <a href="start.html" class="code" title="function [ ok ] = start( obj )">start</a>(obj);
0102         
0103         <span class="comment">% Stop the controller. This also restores the previous</span>
0104         <span class="comment">% control mode for the named motor and eventual coupled</span>
0105         <span class="comment">% motors.</span>
0106         ok = <a href="stop.html" class="code" title="function [ ok ] = stop( obj )">stop</a>(obj);
0107         
0108         <span class="comment">% Select new motor to control in explicit PWM mode. The position</span>
0109         <span class="comment">% control emulation is turned off for this motor.</span>
0110         ok = <a href="switchCtrlledMotor.html" class="code" title="function [ ok ] = switchCtrlledMotor( obj,motorName )">switchCtrlledMotor</a>(obj,motorName);
0111         
0112         <span class="comment">% Set the desired PWM level (Duty cycle) for the currently</span>
0113         <span class="comment">% controlled motor.</span>
0114         ok = <a href="setMotorPWM.html" class="code" title="function [ ok ] = setMotorPWM( obj,pwm )">setMotorPWM</a>(obj,pwm);
0115     <span class="keyword">end</span>
0116     
0117     methods (Access=protected)
0118         <span class="comment">% Emulate position control on all the coupled motors except the</span>
0119         <span class="comment">% motor 'obj.pwmCtrledMotor.name' which is explicitely controlled</span>
0120         <span class="comment">% through PWM.</span>
0121         ok = <a href="runPwmEmulPosCtrlMode.html" class="code" title="function [ ok ] = runPwmEmulPosCtrlMode( obj,samplingPeriod,timeout )">runPwmEmulPosCtrlMode</a>(obj,samplingPeriod,timeout);
0122         ok = <a href="runRealtimePlotter.html" class="code" title="function [ ok ] = runRealtimePlotter( obj,threadPeriod,threadTimeout )">runRealtimePlotter</a>(obj,threadPeriod,threadTimeout);
0123         
0124         <span class="comment">% Rate thread functions for the controller</span>
0125         ok = <a href="ctrllerThreadStartFcn.html" class="code" title="function [ ok ] = ctrllerThreadStartFcn( obj,PIDCtrller )">ctrllerThreadStartFcn</a>(obj,PIDCtrller);
0126         ok = <a href="ctrllerThreadStopFcn.html" class="code" title="function [ ok ] = ctrllerThreadStopFcn( obj )">ctrllerThreadStopFcn</a>(obj);
0127         ok = <a href="ctrllerThreadUpdateFcn.html" class="code" title="function [ ok ] = ctrllerThreadUpdateFcn( obj,ctrllerThreadStop,rateThreadPeriod,PIDCtrller )">ctrllerThreadUpdateFcn</a>(obj,ctrllerThreadStop,rateThreadPeriod,PIDCtrller);
0128         
0129         <span class="comment">% Rate thread functions for the real-time plotter</span>
0130         <a href="plotterThreadStartFcn.html" class="code" title="function plotterThreadStartFcn( obj )">plotterThreadStartFcn</a>(obj);
0131         <a href="plotterThreadStopFcn.html" class="code" title="function plotterThreadStopFcn( obj )">plotterThreadStopFcn</a>(obj);
0132         <a href="plotterThreadUpdateFcn.html" class="code" title="function plotterThreadUpdateFcn( obj )">plotterThreadUpdateFcn</a>(obj);
0133     <span class="keyword">end</span>
0134     
0135 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 10-Jul-2018 15:03:35 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>