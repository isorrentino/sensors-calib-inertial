<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ellipsoidfit_residuals</title>
  <meta name="keywords" content="ellipsoidfit_residuals">
  <meta name="description" content="Finds the distance of the point (x,y,z) to the nearest point on the ellipsoid.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # src --><!-- ../menu.html utils --><!-- menu.html quadfit -->
<h1>ellipsoidfit_residuals
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>Finds the distance of the point (x,y,z) to the nearest point on the ellipsoid.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function [xp,yp,zp] = ellipsoidfit_residuals(x,y,z, center,radii,R) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Finds the distance of the point (x,y,z) to the nearest point on the ellipsoid.

 References:
 David Eberly, &quot;Distance from a Point to an Ellipsoid&quot;, Geometric Tools,
    http://www.geometrictools.com/, 1998-2008</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../src/@y/y.html" class="code" title="">y</a>	</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../src/@SensorDiagnosis/ellipsoid_proj_distance_fromExp.html" class="code" title="function [pVec,dVec,dOrient,d] = ellipsoid_proj_distance_fromExp(x,y,z,centre,radii,R)">ellipsoid_proj_distance_fromExp</a>	Projections and distance of points projected onto an ellipsoid.</li><li><a href="ellipsoid_distance.html" class="code" title="function d = ellipsoid_distance(x,y,z,p)">ellipsoid_distance</a>	Distance of points projected onto an ellipsoid.</li><li><a href="ellipsoidfit.html" class="code" title="function [p,e,d] = ellipsoidfit(x,y,z,varargin)">ellipsoidfit</a>	Fit an ellipsoid to data by minimizing point-to-surface distance.</li><li><a href="example_ellipsoidfit1.html" class="code" title="function example_ellipsoidfit1">example_ellipsoidfit1</a>	Demonstration of various ellipsoid fits.</li><li><a href="plot_ellipsoid_im.html" class="code" title="function plot_ellipsoid_im(p,varargin)">plot_ellipsoid_im</a>	Plot ellipsoid specified with implicit parameters.</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [xp,yp,zp] = ellipsoidfit_residuals(x,y,z, center,radii,R)</a>
0002 <span class="comment">% Finds the distance of the point (x,y,z) to the nearest point on the ellipsoid.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% References:</span>
0005 <span class="comment">% David Eberly, &quot;Distance from a Point to an Ellipsoid&quot;, Geometric Tools,</span>
0006 <span class="comment">%    http://www.geometrictools.com/, 1998-2008</span>
0007 
0008 <span class="comment">% Copyright 2011 Levente Hunyadi</span>
0009 
0010 validateattributes(x, {<span class="string">'numeric'</span>}, {<span class="string">'real'</span>,<span class="string">'nonempty'</span>,<span class="string">'vector'</span>});
0011 validateattributes(<a href="../../../src/@y/y.html" class="code" title="">y</a>, {<span class="string">'numeric'</span>}, {<span class="string">'real'</span>,<span class="string">'nonempty'</span>,<span class="string">'vector'</span>});
0012 validateattributes(z, {<span class="string">'numeric'</span>}, {<span class="string">'real'</span>,<span class="string">'nonempty'</span>,<span class="string">'vector'</span>});
0013 isrow = size(x,2) &gt; size(x,1);
0014 x = x(:);
0015 <a href="../../../src/@y/y.html" class="code" title="">y</a> = <a href="../../../src/@y/y.html" class="code" title="">y</a>(:);
0016 z = z(:);
0017 validateattributes(center, {<span class="string">'numeric'</span>}, {<span class="string">'real'</span>,<span class="string">'vector'</span>});
0018 center = reshape(center,1,3);
0019 validateattributes(center, {<span class="string">'numeric'</span>}, {<span class="string">'size'</span>,[1,3]});
0020 validateattributes(radii, {<span class="string">'numeric'</span>}, {<span class="string">'nonnegative'</span>,<span class="string">'real'</span>,<span class="string">'vector'</span>});
0021 radii = reshape(radii,1,3);
0022 validateattributes(radii, {<span class="string">'numeric'</span>}, {<span class="string">'size'</span>,[1,3]});
0023 validateattributes(R, {<span class="string">'numeric'</span>}, {<span class="string">'2d'</span>,<span class="string">'real'</span>,<span class="string">'size'</span>,[3,3]});
0024 
0025 tolerance = 1e-9;
0026 
0027 <span class="comment">% apply inverse translation and rotation to axis-align data points</span>
0028 Uaa = bsxfun(@minus, [x,<a href="../../../src/@y/y.html" class="code" title="">y</a>,z], center) / R;
0029 
0030 <span class="comment">% project points into first quadrant</span>
0031 Uabs = abs(Uaa);
0032 <span class="comment">%plot3(Uabs(:,1), Uabs(:,2), Uabs(:,3), '.');</span>
0033 
0034 <span class="comment">% set semi-axes</span>
0035 a = radii(1);
0036 b = radii(2);
0037 c = radii(3);
0038 tol = tolerance*max([a,b,c]);
0039 
0040 Uproj = zeros(size(Uaa));
0041 <span class="keyword">if</span> 0  <span class="comment">% C-style implementation</span>
0042     <span class="keyword">for</span> i = 1 : size(Uaa,1);
0043         u = Uabs(i,1);
0044         v = Uabs(i,2);
0045         w = Uabs(i,3);
0046 
0047         <span class="comment">% ellipsoid equation substituting normal vector condition:</span>
0048         <span class="comment">% ((a*u)/(t+a^2))^2 + ((b*v)/(t+b^2))^2 + ((c*w)/(t+c^2))^2 = 1</span>
0049         <span class="comment">%</span>
0050         <span class="comment">% equation whose root t we seek:</span>
0051         <span class="comment">% F(t) = (a^2 + t)^2*(b^2 + t)^2*(c^2 + t)^2</span>
0052         <span class="comment">%      - a^2*u^2*(b^2 + t)^2*(c^2 + t)^2</span>
0053         <span class="comment">%      - b^2*v^2*(a^2 + t)^2*(c^2 + t)^2</span>
0054         <span class="comment">%      - c^2*w^2*(a^2 + t)^2*(b^2 + t)^2 = 0</span>
0055 
0056         <span class="keyword">if</span> u^2/a^2 + v^2/b^2 + w^2/c^2 &lt; 1  <span class="comment">% initial value if (u,v,w) is inside the ellipse</span>
0057             t = 0;
0058         <span class="keyword">else</span>  <span class="comment">% initial value if (u,v,w) is outside the ellipse</span>
0059             t = max([a,b,c])*norm([u,v,w]);
0060         <span class="keyword">end</span>
0061 
0062         <span class="comment">% Newton's method</span>
0063         <span class="keyword">for</span> j = 1 : 100
0064             F = (a^2 + t)^2*(b^2 + t)^2*(c^2 + t)^2 <span class="keyword">...</span>
0065                 - a^2*u^2*(b^2 + t)^2*(c^2 + t)^2 <span class="keyword">...</span>
0066                 - b^2*v^2*(a^2 + t)^2*(c^2 + t)^2 <span class="keyword">...</span>
0067                 - c^2*w^2*(a^2 + t)^2*(b^2 + t)^2;
0068             dF = (2*a^2 + 2*t)*(b^2 + t)^2*(c^2 + t)^2 <span class="keyword">...</span>
0069                 + (2*b^2 + 2*t)*(a^2 + t)^2*(c^2 + t)^2 <span class="keyword">...</span>
0070                 + (2*c^2 + 2*t)*(a^2 + t)^2*(b^2 + t)^2 <span class="keyword">...</span>
0071                 - a^2*u^2*(2*b^2 + 2*t)*(c^2 + t)^2 <span class="keyword">...</span>
0072                 - a^2*u^2*(2*c^2 + 2*t)*(b^2 + t)^2 <span class="keyword">...</span>
0073                 - b^2*v^2*(2*a^2 + 2*t)*(c^2 + t)^2 <span class="keyword">...</span>
0074                 - b^2*v^2*(2*c^2 + 2*t)*(a^2 + t)^2 <span class="keyword">...</span>
0075                 - c^2*w^2*(2*a^2 + 2*t)*(b^2 + t)^2 <span class="keyword">...</span>
0076                 - c^2*w^2*(2*b^2 + 2*t)*(a^2 + t)^2;
0077             r = F / dF;
0078             <span class="keyword">if</span> r &lt; tol
0079                 <span class="keyword">break</span>;
0080             <span class="keyword">end</span>
0081             t = t - r;
0082         <span class="keyword">end</span>
0083 
0084         <span class="comment">% points projected onto ellipsoid x^2/a^2 + y^2/b^2 + z^2/c^2</span>
0085         Uproj(i,1) = (a^2*u)/(t+a^2);  <span class="comment">% x/a = (a*u)/(t+a^2)</span>
0086         Uproj(i,2) = (b^2*v)/(t+b^2);  <span class="comment">% y/b = (b*v)/(t+b^2)</span>
0087         Uproj(i,3) = (c^2*w)/(t+c^2);  <span class="comment">% z/c = (c*w)/(t+c^2)</span>
0088     <span class="keyword">end</span>
0089 <span class="keyword">else</span>  <span class="comment">% vectorized</span>
0090     u = Uabs(:,1);
0091     v = Uabs(:,2);
0092     w = Uabs(:,3);
0093 
0094     t = zeros(size(u));
0095     f = u.^2/a^2 + v.^2/b^2 + w.^2/c^2 &gt; 1;  <span class="comment">% initial value if (u,v,w) is outside the ellipse</span>
0096     t(f) = max([a,b,c])* sum(Uabs(f,:).^2,2);
0097     
0098     <span class="comment">% precalculate terms</span>
0099     a2u2 = a^2*u.^2;
0100     b2v2 = b^2*v.^2;
0101     c2w2 = c^2*w.^2;
0102     
0103     <span class="comment">% Newton's method</span>
0104     <span class="keyword">for</span> j = 1 : 100
0105         a2t = (a^2 + t).^2;
0106         b2t = (b^2 + t).^2;
0107         c2t = (c^2 + t).^2;
0108         F = a2t.*b2t.*c2t <span class="keyword">...</span>
0109             - a2u2.*b2t.*c2t <span class="keyword">...</span>
0110             - b2v2.*a2t.*c2t <span class="keyword">...</span>
0111             - c2w2.*a2t.*b2t;
0112         da2t = 2*(a^2 + t);
0113         db2t = 2*(b^2 + t);
0114         dc2t = 2*(c^2 + t);
0115         dF = da2t.*b2t.*c2t + db2t.*a2t.*c2t + dc2t.*a2t.*b2t <span class="keyword">...</span>
0116             - a2u2.*db2t.*c2t - a2u2.*dc2t.*b2t <span class="keyword">...</span>
0117             - b2v2.*da2t.*c2t - b2v2.*dc2t.*a2t <span class="keyword">...</span>
0118             - c2w2.*da2t.*b2t - c2w2.*db2t.*a2t;
0119         r = F ./ dF;
0120         <span class="keyword">if</span> max(r) &lt; tol
0121             <span class="keyword">break</span>;
0122         <span class="keyword">end</span>
0123         t = t - r;
0124     <span class="keyword">end</span>
0125     
0126     <span class="comment">% points projected onto ellipsoid x^2/a^2 + y^2/b^2 + z^2/c^2</span>
0127     Uproj(:,1) = (a^2*u)./(t+a^2);  <span class="comment">% x/a = (a*u)/(t+a^2)</span>
0128     Uproj(:,2) = (b^2*v)./(t+b^2);  <span class="comment">% y/b = (b*v)/(t+b^2)</span>
0129     Uproj(:,3) = (c^2*w)./(t+c^2);  <span class="comment">% z/c = (c*w)/(t+c^2)</span>
0130 <span class="keyword">end</span>
0131 <span class="comment">%plot3(Uproj(:,1), Uproj(:,2), Uproj(:,3), '.');</span>
0132 
0133 <span class="comment">% map back into originating quadrant</span>
0134 Uproj(:,1) = sign(Uaa(:,1)) .* Uproj(:,1);
0135 Uproj(:,2) = sign(Uaa(:,2)) .* Uproj(:,2);
0136 Uproj(:,3) = sign(Uaa(:,3)) .* Uproj(:,3);
0137 
0138 U = bsxfun(@plus, Uproj * R, center);
0139 xp = U(:,1);
0140 yp = U(:,2);
0141 zp = U(:,3);
0142 <span class="keyword">if</span> isrow
0143     xp = transpose(xp);
0144     yp = transpose(yp);
0145     zp = transpose(zp);
0146 <span class="keyword">end</span>
0147 <span class="keyword">if</span> nargout &lt; 3
0148     plot3(xp,yp,zp,<span class="string">'.'</span>);
0149 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 10-Jul-2018 15:03:35 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>