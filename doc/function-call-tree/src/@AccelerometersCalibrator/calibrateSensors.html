<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of calibrateSensors</title>
  <meta name="keywords" content="calibrateSensors">
  <meta name="description" content="% Comparing the eccentrity of several &quot;grid&quot; dataset measured on the iCub Robot">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # src --><!-- menu.html @AccelerometersCalibrator -->
<h1>calibrateSensors
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>% Comparing the eccentrity of several &quot;grid&quot; dataset measured on the iCub Robot</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function calibrateSensors(~,dataPath,~,measedSensorList,measedPartsList,model,taskSpecificParams) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">% Comparing the eccentrity of several &quot;grid&quot; dataset measured on the iCub Robot
 This script take dataset in the &quot;grid&quot; format (generated by
 reachRandomJointPositions [1] module) on the iCub robot and compare 
 the eccentrity of the force measurement. In theory the &quot;grid&quot; movement
 is slowly (so the only thing that matters is gravity) moving the legs,
 while the robot is fixed on the pole (so the only external force are 
 on the root_link). In theory then the measured force should be equal 
 to m*g , where g \in R^3 is the gravity expressed in the sensor frame. 
 Hence the measured force should lie on a sphere (eccentrities 0,0) in
 theory. However imperfect sensor can have a different eccentricities (
 but in general they remain linear, so the sphere become an ellipsoid).
 For more on the theory behind this script, check [2].
 [1] : https://github.com/robotology/codyco-modules/tree/master/src/misc/reachRandomJointPositions
 [2] : Traversaro, Silvio, Daniele Pucci, and Francesco Nori. 
       &quot;In situ calibration of six-axis force-torque sensors using accelerometer measurements.&quot;
       Robotics and Automation (ICRA), 2015 IEEE International Conference on. IEEE, 2015.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../src/@Calibrator/run.html" class="code" title="function run(obj,init,model,lastAcqSensorDataAccessorMap)">run</a>	Calibrates the sensors using the data accessed through 'lastAcqSensorDataAccessorMap'</li><li><a href="../../src/@LowlevTauCtrlCalibrator/run.html" class="code" title="function run(obj,init,model,lastAcqSensorDataAccessorMap)">run</a>	Calibrates the sensors using the data accessed through 'lastAcqSensorDataAccessorMap'</li><li><a href="../../src/@MotionSequencer/run.html" class="code" title="function acqSensorDataAccessor = run(obj)">run</a>	</li><li><a href="../../src/@SensorsData/SensorsData.html" class="code" title="">SensorsData</a>	</li><li><a href="../../src/conf/advanced/accelerometersCalibratorDevConfig.html" class="code" title="">accelerometersCalibratorDevConfig</a>	%</li><li><a href="../../src/utils/quadfit/ellipsoid_im2ex.html" class="code" title="function [center,radii,quat,R] = ellipsoid_im2ex(v)">ellipsoid_im2ex</a>	Cast ellipsoid defined with implicit parameter vector to explicit form.</li><li><a href="../../src/utils/quadfit/ellipsoidfit.html" class="code" title="function [p,e,d] = ellipsoidfit(x,y,z,varargin)">ellipsoidfit</a>	Fit an ellipsoid to data by minimizing point-to-surface distance.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="AccelerometersCalibrator.html" class="code" title="">AccelerometersCalibrator</a>	</li><li><a href="../../src/@Calibrator/Calibrator.html" class="code" title="">Calibrator</a>	</li><li><a href="../../src/@JointEncodersCalibrator/JointEncodersCalibrator.html" class="code" title="">JointEncodersCalibrator</a>	</li><li><a href="../../src/@LowlevTauCtrlCalibrator/LowlevTauCtrlCalibrator.html" class="code" title="">LowlevTauCtrlCalibrator</a>	</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function calibrateSensors(~,</a><span class="keyword">...</span>
0002     dataPath,~,measedSensorList,measedPartsList,<span class="keyword">...</span>
0003     model,taskSpecificParams)
0004 <span class="comment">%% Comparing the eccentrity of several &quot;grid&quot; dataset measured on the iCub Robot</span>
0005 <span class="comment">% This script take dataset in the &quot;grid&quot; format (generated by</span>
0006 <span class="comment">% reachRandomJointPositions [1] module) on the iCub robot and compare</span>
0007 <span class="comment">% the eccentrity of the force measurement. In theory the &quot;grid&quot; movement</span>
0008 <span class="comment">% is slowly (so the only thing that matters is gravity) moving the legs,</span>
0009 <span class="comment">% while the robot is fixed on the pole (so the only external force are</span>
0010 <span class="comment">% on the root_link). In theory then the measured force should be equal</span>
0011 <span class="comment">% to m*g , where g \in R^3 is the gravity expressed in the sensor frame.</span>
0012 <span class="comment">% Hence the measured force should lie on a sphere (eccentrities 0,0) in</span>
0013 <span class="comment">% theory. However imperfect sensor can have a different eccentricities (</span>
0014 <span class="comment">% but in general they remain linear, so the sphere become an ellipsoid).</span>
0015 <span class="comment">% For more on the theory behind this script, check [2].</span>
0016 <span class="comment">% [1] : https://github.com/robotology/codyco-modules/tree/master/src/misc/reachRandomJointPositions</span>
0017 <span class="comment">% [2] : Traversaro, Silvio, Daniele Pucci, and Francesco Nori.</span>
0018 <span class="comment">%       &quot;In situ calibration of six-axis force-torque sensors using accelerometer measurements.&quot;</span>
0019 <span class="comment">%       Robotics and Automation (ICRA), 2015 IEEE International Conference on. IEEE, 2015.</span>
0020 
0021 <span class="comment">% Get calibration map</span>
0022 calibrationMap = model.calibrationMap;
0023 
0024 <span class="comment">% Unwrap task specific parameters (defines 'calibedJointsIdxes')</span>
0025 Init.unWrap(taskSpecificParams);
0026 
0027 <span class="comment">% Advanced interface parameters</span>
0028 <a href="../../src/@Calibrator/run.html" class="code" title="function run(obj,init,model,lastAcqSensorDataAccessorMap)">run</a> <a href="../../src/conf/advanced/accelerometersCalibratorDevConfig.html" class="code" title="">accelerometersCalibratorDevConfig</a>;
0029 
0030 <span class="comment">% Build inertial sensors parameters</span>
0031 modelParams = model.buildModelParams(<span class="keyword">...</span>
0032     measedSensorList,measedPartsList,<span class="keyword">...</span>
0033     {},[],<span class="keyword">...</span><span class="comment">  % no need for calibration parts information</span>
0034     mtbSensorAct);
0035 
0036 <span class="comment">%% build input data for calibration</span>
0037 <span class="comment">%</span>
0038 
0039 <span class="keyword">switch</span> loadSource
0040     <span class="keyword">case</span> <span class="string">'cache'</span>
0041         load([dataPath <span class="string">'/dataCache.mat'</span>],<span class="string">'data'</span>);
0042         
0043     <span class="keyword">case</span> <span class="string">'dumpFile'</span>
0044         <span class="comment">% build sensor data parser</span>
0045         plot = false; loadJointPos = false;
0046         data = <a href="../../src/@SensorsData/SensorsData.html" class="code" title="">SensorsData</a>(dataPath,<span class="string">''</span>,subSamplingSize,<span class="keyword">...</span>
0047             timeStart,timeStop,plot);
0048         [sensorsIdxListFile,sensMeasCell] = data.buildInputDataSet(loadJointPos,modelParams);
0049         
0050         <span class="comment">% Save data in a Matlab file for faster access in further runs</span>
0051         <span class="keyword">if</span> saveToCache
0052             save([dataPath <span class="string">'/dataCache.mat'</span>],<span class="string">'data'</span>);
0053         <span class="keyword">end</span>
0054         
0055     <span class="keyword">otherwise</span>
0056         disp(<span class="string">'Unknown data source !!'</span>)
0057 <span class="keyword">end</span>
0058 
0059 <span class="comment">%% ========================================== CALIBRATION ==========================================</span>
0060 <span class="comment">%</span>
0061 <span class="comment">%                          ellipsoid fitting and distance to ellipsoid</span>
0062 <span class="comment">%</span>
0063 
0064 ellipsoid_p = cell(1,length(sensorsIdxListFile)); <span class="comment">% implicit parameters</span>
0065 calib = cell(1,length(sensorsIdxListFile)); <span class="comment">% explicit parameters</span>
0066 ellipsoid_e = cell(1,length(sensorsIdxListFile)); <span class="comment">% least squares error</span>
0067 ellipsoid_d = cell(1,length(sensorsIdxListFile)); <span class="comment">% distance to surface</span>
0068 
0069 <span class="keyword">for</span> acc_i = sensorsIdxListFile
0070     [ellipsoid_p{acc_i},ellipsoid_e{acc_i},ellipsoid_d{acc_i}] = <a href="../../src/utils/quadfit/ellipsoidfit.html" class="code" title="function [p,e,d] = ellipsoidfit(x,y,z,varargin)">ellipsoidfit</a>( <span class="keyword">...</span>
0071         sensMeasCell{1,acc_i}(:,1), <span class="keyword">...</span>
0072         sensMeasCell{1,acc_i}(:,2), <span class="keyword">...</span>
0073         sensMeasCell{1,acc_i}(:,3));
0074     [calib{acc_i}.centre,radii,calib{acc_i}.quat,calib{acc_i}.R] = <span class="keyword">...</span>
0075         <a href="../../src/utils/quadfit/ellipsoid_im2ex.html" class="code" title="function [center,radii,quat,R] = ellipsoid_im2ex(v)">ellipsoid_im2ex</a>(ellipsoid_p{1,acc_i}); <span class="comment">% convert implicit to explicit</span>
0076     <span class="comment">% convert ellipsoid axis lengths to rates</span>
0077     calib{acc_i}.radii = radii/9.807;
0078     <span class="comment">% compute full calibration matrix combining elongation and rotation</span>
0079     calib{acc_i}.C = calib{acc_i}.R'*inv(diag(calib{acc_i}.radii))*calib{acc_i}.R;
0080 <span class="keyword">end</span>
0081 
0082 <span class="comment">% Create mapping extension with new calibrated frames</span>
0083 calibratedFrames = data.frames(1,sensorsIdxListFile);
0084 calibMapExt = containers.Map(calibratedFrames,calib);
0085 <span class="keyword">for</span> cKey = calibMapExt.keys   <span class="comment">% go through all elements of the map extension</span>
0086     key = cell2mat(cKey);     <span class="comment">% decapsulate key</span>
0087     calibrationMap(key) = calibMapExt(key);
0088 <span class="keyword">end</span>
0089 
0090 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 10-Jul-2018 15:03:35 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>